var exec = require('child_process').exec;
var through  = require('through2');
var gutil = require('gulp-util');
var ext   = gutil.replaceExtension;
module.exports = function(opt){
	var func = function (file,enc,cb){
		var content = file.contents.toString();
		var url = " "+content.match(/<string>([^<]*)<\/string>/i)[1];
		var size,dir,clipsize,useragent,datestamp,name,zoom,scale;
		size=dir=clipsize=useragent=datestamp=name=zoom=scale="";
		if(opt.browserWidth && opt.browserHeight){
			size += " -W "+opt.browserWidth+" -H "+opt.browserHeight;
		}
		if(opt.clipWidth && opt.clipHeight){
			clipsize = " --clipwidth="+opt.clipWidth+" "+"--clipheight="+opt.clipHeight;
		}
		if(opt.dir){
			dir += " --dir="+opt.dir;
		}
		if(opt.datestamp == true){
			datestamp += " --datestamp";
		}
		if(opt.useragent){
			useragent +=" --user-agent="+opt.useragent;
		}
		if(opt.name){
			name += " --filename="+opt.name;
		}
		if(opt.zoom){
			zoom += " --zoom="+opt.zoom;
		}
		if(opt.scale){
			scale += " --scale="+opt.scale;
		}else{
			scale += " --scale=1";
		}
		console.log("webkit2png"+size+url+dir+clipsize+useragent+datestamp+name+zoom+scale);
		exec("webkit2png"+size+url+dir+clipsize+useragent+datestamp+name+zoom+scale);
		this.push(file);
		cb();
	};
	return through.obj(func)
}