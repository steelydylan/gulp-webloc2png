var exec = require('child_process').exec;
var through  = require('through2');
var gutil = require('gulp-util');
var ext   = gutil.replaceExtension;
module.exports = function(opt){
	var func = function (file,enc,cb){
		var content = file.contents.toString();
		var url = content.match(/<string>([^<]*)<\/string>/i)[1];
		var size = "";
		if(opt.width && opt.height){
			size += " -W "+opt.width+" -H "+opt.height;
		}
		exec("webkit2png "+url+" --dir="+opt.dest+size);
		this.push(file);
		cb();
	};
	return through.obj(func)
}